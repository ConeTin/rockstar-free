package ru.rockstar.client.features.impl.combat;

import java.awt.Color;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.Objects;

import org.lwjgl.input.Mouse;
import org.lwjgl.opengl.GL11;

import net.minecraft.block.Block;
import net.minecraft.block.BlockLiquid;
import net.minecraft.client.Minecraft;
import net.minecraft.client.gui.ScaledResolution;
import net.minecraft.client.renderer.GlStateManager;
import net.minecraft.entity.Entity;
import net.minecraft.entity.EntityLivingBase;
import net.minecraft.entity.item.EntityArmorStand;
import net.minecraft.entity.item.EntityEnderCrystal;
import net.minecraft.entity.monster.EntityMob;
import net.minecraft.entity.passive.EntityAnimal;
import net.minecraft.entity.passive.EntityVillager;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.item.ItemAxe;
import net.minecraft.item.ItemShield;
import net.minecraft.item.ItemSword;
import net.minecraft.network.play.client.CPacketEntityAction;
import net.minecraft.network.play.client.CPacketHeldItemChange;
import net.minecraft.network.play.client.CPacketPlayerDigging;
import net.minecraft.network.play.client.CPacketUseEntity;
import net.minecraft.network.play.server.SPacketPlayerPosLook;
import net.minecraft.util.EnumFacing;
import net.minecraft.util.EnumHand;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.math.MathHelper;
import net.minecraft.util.math.Vec3d;
import ru.rockstar.Main;
import ru.rockstar.api.event.EventTarget;
import ru.rockstar.api.event.event.EventAttackSilent;
import ru.rockstar.api.event.event.EventPacket;
import ru.rockstar.api.event.event.EventPreMotionUpdate;
import ru.rockstar.api.event.event.EventRender2D;
import ru.rockstar.api.event.event.EventSendPacket;
import ru.rockstar.api.event.event.EventUpdate;
import ru.rockstar.api.utils.combat.EntityHelper;
import ru.rockstar.api.utils.combat.GCDFix;
import ru.rockstar.api.utils.combat.KillAuraHelper;
import ru.rockstar.api.utils.combat.Point;
import ru.rockstar.api.utils.combat.RangeHelper;
import ru.rockstar.api.utils.combat.RotationHelper;
import ru.rockstar.api.utils.friend.Friend;
import ru.rockstar.api.utils.math.GCDCalcHelper;
import ru.rockstar.api.utils.math.MathematicHelper;
import ru.rockstar.api.utils.movement.MovementHelper;
import ru.rockstar.api.utils.other.Util;
import ru.rockstar.api.utils.render.AnimationHelper;
import ru.rockstar.api.utils.render.ClientHelper;
import ru.rockstar.api.utils.render.DrawHelper;
import ru.rockstar.api.utils.render.RenderUtils;
import ru.rockstar.api.utils.render.RoundedUtil;
import ru.rockstar.api.utils.world.InventoryHelper;
import ru.rockstar.client.features.Category;
import ru.rockstar.client.features.Feature;
import ru.rockstar.client.features.impl.movement.Jesus;
import ru.rockstar.client.ui.draggable.DraggableModule;
import ru.rockstar.client.ui.draggable.impl.TargetHudComponent;
import ru.rockstar.client.ui.settings.impl.BooleanSetting;
import ru.rockstar.client.ui.settings.impl.ListSetting;
import ru.rockstar.client.ui.settings.impl.NumberSetting;

public class Aura extends Feature {
	
	public static BooleanSetting crysSafe;
	public static BooleanSetting invisiblecheck;
	public static BooleanSetting auramobs;
	public static EntityLivingBase target ;
	public static BooleanSetting predict;
	public static BooleanSetting targetHud;
	public static BooleanSetting snap;
	public static BooleanSetting smartFix;
	public static BooleanSetting dynamicRange;
	public static NumberSetting range2;
	public static float range;
	public static int hitCounter;
	   public static float progress;
	    public static float progress2;
	    private long lastMS;
	    public static double healthBarWidth;
    public Aura() {
        super("Aura", "Новая килл-аура", 0, Category.COMBAT);
        crysSafe = new BooleanSetting("Crystal Safe", true, () -> true);
        dynamicRange = new BooleanSetting("Dynamic Range", "Динамическая дистанция", false, () -> true);
        range2 = new NumberSetting("Range", "Дистанция для удара", 3.2f, 1, 6, 0.1f, () -> !dynamicRange.getBoolValue());
        predict = new BooleanSetting("Predict", "Предиктиться", false, () -> true);
        snap = new BooleanSetting("Snap", "Под нексус гриф", false, () -> true);
        smartFix = new BooleanSetting("Smart Fix", "Использует шелд фикс по другому, полезно для дуэлей", true, () -> true);
        auramobs = new BooleanSetting("Mobs", "Позволяет бить мобов", true, () -> true);
        invisiblecheck = new BooleanSetting("Invisible", "Позволяет бить невидемых существ", true, () -> true);
        addSettings(auramobs, dynamicRange, range2, invisiblecheck, smartFix, snap, crysSafe);
    }
    
    public boolean canAttack(EntityLivingBase player) {
    	 if (player instanceof EntityPlayer || player instanceof EntityAnimal || player instanceof EntityMob
                 || player instanceof EntityVillager) {
             if (player instanceof EntityAnimal && !auramobs.getBoolValue()) {
                 return false;
             }
             if (player instanceof EntityMob && !auramobs.getBoolValue()) {
                 return false;
             }

             if (player instanceof EntityVillager && !auramobs.getBoolValue()) {
                 return false;
             }
         }
        if (player.isInvisible() && !invisiblecheck.getBoolValue()) {
            return false;
        }
        if (player instanceof EntityArmorStand) {
            return false;
        }

        for (Friend friend : Main.instance.friendManager.getFriends()) {
            if (!player.getName().equals(friend.getName())) {
            	continue;
            } else {
            	return false;
            }
        }

        if (Main.instance.featureDirector.getFeatureByClass(AntiBot.class).isToggled() && AntiBot.isBotPlayer.contains(player)) {
            return false;
        }
        if (!range(player, calculateRange())) {
            return false;
        }
        return player != mc.player;
    }
    
    private static boolean range(EntityLivingBase entity, double range) {
        mc.player.getDistanceToEntity(entity);
        return (double) mc.player.getDistanceToEntity(entity) <= range;
    }
    
    public float calculateRange() {
    	float y = range;
    	if (this.isToggled()) {
			if (dynamicRange.getBoolValue()) {
				if (hitCounter <= 7) {
					range = 3.5f;
				} else {
					range = 3.1f;
				}
			} else {
				range = range2.getNumberValue();
			}
			
			if (target != null) {
    			if (mc.player.posY < target.posY) {
    				y = (float) (range + (target.posY - mc.player.posY));
    			} else if (mc.player.posY == target.posY) {
    				y = range;
    			} else {
    				y = (float) (range + (mc.player.posY - target.posY));
    			}
    		}
			
			return y;
		} else {
			return 0;
		}
	}
    
    @EventTarget
    public void onSendPacket(EventSendPacket event) {
        if (event.getPacket() instanceof CPacketUseEntity) {
            CPacketUseEntity cPacketUseEntity = (CPacketUseEntity) event.getPacket();

            if (cPacketUseEntity.getAction() == CPacketUseEntity.Action.INTERACT) {
                event.setCancelled(true);
            }

            if (cPacketUseEntity.getAction() == CPacketUseEntity.Action.INTERACT_AT) {
                event.setCancelled(true);
            }
        }
    }
    
    public static float[] rotations(Entity entityIn) {
    	/*
        double diffX = entityIn.posX + ((entityIn.posX - entityIn.prevPosX)) * (predict.getBoolValue() ? mc.player.connection.getPlayerInfo(mc.player.getUniqueID()).getResponseTime() / 2 : 0)  - mc.player.posX - mc.player.motionX * (predict.getBoolValue() ? mc.player.connection.getPlayerInfo(mc.player.getUniqueID()).getResponseTime() / 2 : 0);
        double diffZ = entityIn.posZ + ((entityIn.posZ - entityIn.prevPosZ))  * (predict.getBoolValue() ? mc.player.connection.getPlayerInfo(mc.player.getUniqueID()).getResponseTime() / 2 : 0) - mc.player.posZ - mc.player.motionZ * (predict.getBoolValue() ? mc.player.connection.getPlayerInfo(mc.player.getUniqueID()).getResponseTime() / 2 : 0);
        double diffY = (entityIn instanceof EntityLivingBase) ? (entityIn.posY + entityIn.getEyeHeight() - (mc.player.posY + mc.player.getEyeHeight()) - ((KillAura.walls.getBoolValue() && !((EntityLivingBase)entityIn).canEntityBeSeen((Entity)mc.player)) ? -0.38 : ((0.25)))) : ((1 + 1) / 2.0 - (mc.player.posY + mc.player.getEyeHeight()));
        final double diffXZ = MathHelper.sqrt(diffX * diffX + diffZ * diffZ);
        float yaw = (float)(Math.atan2(diffZ, diffX) * 180.0 / 3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632788659361533818279682303019520353018529689957736225994138912497217752834791315155748572424541506959508295331168617278558890750983817546374649393192550604009277016711390098488240128583616035637076601047101819429555961989467678374494482553797747268471040475346462080466842590694912933136770289891521047521620569660240580381501935112533824300355876402474964732639141992726042699227967823547816360093417216412199245863150302861829745557067498385054945885869269956909272107975093029553211653449872027559602364806654991198818347977535663698074265425278625518184175746728909777727938000816470600161452491921732172147723501414419735685481613611573525521334757418494684385233239073941433345477624168625189835694855620992192221842725502542568876717904946016534668049886272327917860857843838279679766814541009538837863609506800642251252051173929848960841284886269456042419652850222106611863067442786220391949450471237137869609563643719172874677646575739624138908658326459958133904780275900994657640789512694683983525957098258226205224894077267194782684826014769909026401363944374553050682034962524517493996514314298091906592509372216964615157098583874105978859597729754989301617539284681382686838689427741559918559252459539594310499725246808459872736446958486538367362226260991246080512438843904512441365497627807977156914359977001296160894416948685558484063534220722258284886481584560285060168427394522674676788952521385225499546667278239864565961163548862305774564980355936345681743241125150760694794510965960940252288797108931456691368672287489405601015033086179286809208747609178249385890097149096759852613655497818931297848216829989487226588048575640142704775551323796414515237462343645428584447952658678210511413547357395231134271661021359695362314429524849371871101457654035902799344037420073105785390621983874478084784896833214457138687519435064302184531910484810053706146806749192781911979399520614196634287544406437451237181921799983910159195618146751426912397489409071864942319615679452080951465502252316038819301420937621378559566389377870830390697920773467221825625996615014215030680384477345492026054146659252014974428507325186660021324340881907104863317346496514539057962685610055081066587969981635747363840525714591028970641401109712062804390397595156771577004203378699360072305587631763594218731251471205329281918261861258673215791984148488291644706095752706957220917567116722910981690915280173506712748583222871835209353965725121083579151369882091444210067510334671103141267111369908658516398315019701651511685171437657618351556508849099898599823873455283316355076479185358932261854896321329330898570642046752590709154814165498594616371802709819943099244889575712828905923233260972997120844335732654893823911932597463667305836041428138830320382490375898524374417029132765618093773444030707469211201913020330380197621101100449293215160842444859637669838952286847831235526582131449576857262433441893039686426243410773226978028073189154411010446823252716201052652272111660396665573092547110557853763466820653109896526918620564769312570586356620185581007293606598764861179104533488503461136576867532494416680396265797877185560845529654126654085306143444318586769751456614068007002378776591344017127494704205622305389945613140711270004078547332699390814546646458807972708266830634328587856983052358089330657574067954571637752542021149557615814002501262285941302164715509792592309907965473761255176567513575178296664547791745011299614890304639947132962107340437518957359614589019389713111790429782856475032031986915140287080859904801094121472213179476477726224142548545403321571853061422881375850430633217518297986622371721591607716692547487389866549494501146540628433663937900397692656721463853067360965712091807638327166416274888800786925602902284721040317211860820419000422966171196377921337575114959501566049631862947265473642523081770367515906735023507283540567040386743513622224771589150495309844489333096340878076932599397805419341447377441842631298608099888687413260472156951623965864573021631598193195167353812974167729478672422924654366800980676928238280689964004824354037014163149658979409243237896907069779422362508221688957383798623001593776471651228935786015881617557829735233446042815126272037343146531977774160319906655418763979293344195215413418994854447345673831624993419131814809277771038638773431772075456545322077709212019051660962804909263601975988281613323166636528619326686336062735676303544776280350450777235547105859548702790814356240145171806246436267945612753181340783303362542327839449753824372058353114771199260638133467768796959703098339130771098704085913374641442822772634659470474587847787201927715280731767907707157213444730605700733492436931138350493163128404251219256517980694113528013147013047816437885185290928545201165839341965621349143415956258658655705526904965209858033850722426482939728584783163057777560688876446248246857926039535277348030480290058760758251047470916439613626760449256274204208320856611906254543372131535958450687724602901618766795240616342522577195429162991930645537799140373404328752628889639958794757291746426357455254079091451357111369410911939325191076020825202618798531887705842972591677813149699009019211697173727847684726860849003377024242916513005005168323364350389517029893922334517220138128069650117844087451960121228599371623130171144484640903890644954440061986907548516026327505298349187407866808818338510228334508504860825039302133219715518430635455007668282949304137765527939751754613953984683393638304746119966538581538420568533862186725233402830871123282789212507712629463229563989898935821167456270102183564622013496715188190973038119800497340723961036854066431939509790190699639552453005450580685501956730229219139339185680344903982059551002263535361920419947455385938102343955449597783779023742161727111723643435439478221818528624085140066604433258885698670543154706965747458550332323342107301545940516553790686627333799585115625784322988273723198987571415957811196358330059408730681216028764962867446047746491599505497374256269010490377819868359381465741268049256487985561453723478673303904688383436346553794986419270563872931748723320837601123029911367938627089438799362016295154133714248928307220126901475466847653576164773794675200490757155527819653621323926406160136358155907422020203187277605277219005561484255518792530343513984425322341576233610642506390497500865627109535919465897514131034822769306247435363256916078154781811528436679570611086153315044521274739245449454236828860613408414863776700961207151249140430272538607648236341433462351897576645216413767969031495019108575984423919862916421939949072362346468441173940326591840443780513338945257423995082965912285085558215725031071257012668302402929525220118726767562204154205161841634847565169998116141010029960783869092916030288400269104140792886215078424516709087000699282120660418371806535567252532567532861291042487761825829765157959847035622262934860034158722980534989650226291748788202734209222245339856264766914905562842503912757710284027998066365825488926488025456610172967026640765590429099456815065265305371829412703369313785178609040708667114965583434347693385781711386455873678123014587687126603489139095620099393610310291616152881384379099042317473363948045759314931405297634757481193567091101377517210080315590248530906692037671922033229094334676851422144773793937517034436619910403375111735471918550464490263655128162288244625759163330391072253837421821408835086573917715096828874782656995995744906617583441375223970968340800535598491754173818839994469748676265516582765848358845314277568790029095170283529716344562129640435231176006651012412006597558512761785838292041974844236080071930457618932349229279650198751872127267507981255470958904556357921221033346697499235630254947802490114195212382815309114079073860251522742995818072471625916685451333123948049470791191532673430282441860414263639548000448002670496248201792896476697583183271314251702969234889627668440323260927524960357996469256504936818360900323809293459588970695365349406034021665443755890045632882250545255640564482465151875471196218443965825337543885690941130315095261793780029741207665147939425902989695946995565761218656196733786236256125216320862869222103274889218654364802296780705765615144632046927906821207388377814233562823608963208068222468012248261177185896381409183903673672220888321513755600372798394004152970028783076670944474560134556417254370906979396122571429894671543578468788614445812314593571984922528471605049221242470141214780573455105008019086996033027634787081081754501193071412233908663938339529425786905076431006383519834389341596131854347546495569781038293097164651438407007073604112373599843452251610507027056235266012764848308407611830130527932054274628654036036745328651057065874882256981579367897669742205750596834408697350201410206723585020072452256326513410559240190274216248439140359989535394590944070469120914093870012645600162374288021092764579310657922955249887275846101264836999892256959688159205600101655256375678566722796619885782794848855834397518744545512965634434803966420557982936804352202770984294232533022576341807039476994159791594530069752148293366555661567873640053666564165473217043903521329543529169414599041608753201868379370234888689479151071637852902345292440773659495630510074210871426134974595615138498713757047101787957310422969066670214498637464595280824369445789772330048764765241339075920434019634039114732023380715095222010682563427471646024335440051521266932493419673977041595683753555166730273900749729736354964533288869844061196496162773449518273695588220757355176651589855190986665393549481068873206859907540792342402300925900701731960362254756478940647548346647760411463233905651343306844953979070903023460461470961696886885014083470405460742958699138296682468185710318879065287036650832431974404771855678934823089431068287027228097362480939962706074726455399253994428081137369433887294063079261595995462624629707062594845569034711972996409089418059534393251236235508134949004364278527138315912568989295196427287573946914272534366941532361004537304881985517065941217352462589548730167600298865925786628561249665523533829428785425340483083307016537228563559152534784459818313411290019992059813522051173365856407826484942764411376393866924803118364453698589175442647399882284621844900877769776312795722672655562596282542765318300134070922334365779160128093179401718598599933849235495640057099558561134980252499066984233017350358044081168552653117099570899427328709258487894436460050410892266917835258707859512983441729535195378855345737426085902908176515578039059464087350612322611200937310804854852635722825768203416050484662775045003126200800799804925485346941469775164932709504934639382432227188515974054702148289711177792376122578873477188196825462981268685817050740272550263329044976277894423621674119186269439650671515779586756482399391760426017633870454990176143641204692182370764887834196896861181558158736062938603810171215855272668300823834046564758804051380801633638874216371406435495561868964112282140753302655100424104896783528588290243670904887118190909494533144218287661810310073547705498159680772009474696134360928614849417850171807793068108546900094458995279424398139213505586422196483491512639012803832001097738680662877923971801461343244572640097374257007359210031541508936793008169980536520276007277496745840028362405346037263416554259027601834840306811381855105979705664007509426087885735796037324514146786703688098806097164258497595138069309449401515422221943291302173912538355915031003330325111749156969174502714943315155885403922164097229101129035521815762823283182342548326111912800928252561902052630163911477247331485739107775874425387611746578671169414776421441111263583553 - 90.0);
        float pitch = (float)(-(Math.atan2(diffY, diffXZ) * 180.0 / ((KillAura.walls.getBoolValue() && !((EntityLivingBase)entityIn).canEntityBeSeen((Entity)mc.player)) ? 3.1 : (3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632788659361533818279682303019520353018529689957736225994138912497217752834791315155748572424541506959508295331168617278558890750983817546374649393192550604009277016711390098488240128583616035637076601047101819429555961989467678374494482553797747268471040475346462080466842590694912933136770289891521047521620569660240580381501935112533824300355876402474964732639141992726042699227967823547816360093417216412199245863150302861829745557067498385054945885869269956909272107975093029553211653449872027559602364806654991198818347977535663698074265425278625518184175746728909777727938000816470600161452491921732172147723501414419735685481613611573525521334757418494684385233239073941433345477624168625189835694855620992192221842725502542568876717904946016534668049886272327917860857843838279679766814541009538837863609506800642251252051173929848960841284886269456042419652850222106611863067442786220391949450471237137869609563643719172874677646575739624138908658326459958133904780275900994657640789512694683983525957098258226205224894077267194782684826014769909026401363944374553050682034962524517493996514314298091906592509372216964615157098583874105978859597729754989301617539284681382686838689427741559918559252459539594310499725246808459872736446958486538367362226260991246080512438843904512441365497627807977156914359977001296160894416948685558484063534220722258284886481584560285060168427394522674676788952521385225499546667278239864565961163548862305774564980355936345681743241125150760694794510965960940252288797108931456691368672287489405601015033086179286809208747609178249385890097149096759852613655497818931297848216829989487226588048575640142704775551323796414515237462343645428584447952658678210511413547357395231134271661021359695362314429524849371871101457654035902799344037420073105785390621983874478084784896833214457138687519435064302184531910484810053706146806749192781911979399520614196634287544406437451237181921799983910159195618146751426912397489409071864942319615679452080951465502252316038819301420937621378559566389377870830390697920773467221825625996615014215030680384477345492026054146659252014974428507325186660021324340881907104863317346496514539057962685610055081066587969981635747363840525714591028970641401109712062804390397595156771577004203378699360072305587631763594218731251471205329281918261861258673215791984148488291644706095752706957220917567116722910981690915280173506712748583222871835209353965725121083579151369882091444210067510334671103141267111369908658516398315019701651511685171437657618351556508849099898599823873455283316355076479185358932261854896321329330898570642046752590709154814165498594616371802709819943099244889575712828905923233260972997120844335732654893823911932597463667305836041428138830320382490375898524374417029132765618093773444030707469211201913020330380197621101100449293215160842444859637669838952286847831235526582131449576857262433441893039686426243410773226978028073189154411010446823252716201052652272111660396665573092547110557853763466820653109896526918620564769312570586356620185581007293606598764861179104533488503461136576867532494416680396265797877185560845529654126654085306143444318586769751456614068007002378776591344017127494704205622305389945613140711270004078547332699390814546646458807972708266830634328587856983052358089330657574067954571637752542021149557615814002501262285941302164715509792592309907965473761255176567513575178296664547791745011299614890304639947132962107340437518957359614589019389713111790429782856475032031986915140287080859904801094121472213179476477726224142548545403321571853061422881375850430633217518297986622371721591607716692547487389866549494501146540628433663937900397692656721463853067360965712091807638327166416274888800786925602902284721040317211860820419000422966171196377921337575114959501566049631862947265473642523081770367515906735023507283540567040386743513622224771589150495309844489333096340878076932599397805419341447377441842631298608099888687413260472156951623965864573021631598193195167353812974167729478672422924654366800980676928238280689964004824354037014163149658979409243237896907069779422362508221688957383798623001593776471651228935786015881617557829735233446042815126272037343146531977774160319906655418763979293344195215413418994854447345673831624993419131814809277771038638773431772075456545322077709212019051660962804909263601975988281613323166636528619326686336062735676303544776280350450777235547105859548702790814356240145171806246436267945612753181340783303362542327839449753824372058353114771199260638133467768796959703098339130771098704085913374641442822772634659470474587847787201927715280731767907707157213444730605700733492436931138350493163128404251219256517980694113528013147013047816437885185290928545201165839341965621349143415956258658655705526904965209858033850722426482939728584783163057777560688876446248246857926039535277348030480290058760758251047470916439613626760449256274204208320856611906254543372131535958450687724602901618766795240616342522577195429162991930645537799140373404328752628889639958794757291746426357455254079091451357111369410911939325191076020825202618798531887705842972591677813149699009019211697173727847684726860849003377024242916513005005168323364350389517029893922334517220138128069650117844087451960121228599371623130171144484640903890644954440061986907548516026327505298349187407866808818338510228334508504860825039302133219715518430635455007668282949304137765527939751754613953984683393638304746119966538581538420568533862186725233402830871123282789212507712629463229563989898935821167456270102183564622013496715188190973038119800497340723961036854066431939509790190699639552453005450580685501956730229219139339185680344903982059551002263535361920419947455385938102343955449597783779023742161727111723643435439478221818528624085140066604433258885698670543154706965747458550332323342107301545940516553790686627333799585115625784322988273723198987571415957811196358330059408730681216028764962867446047746491599505497374256269010490377819868359381465741268049256487985561453723478673303904688383436346553794986419270563872931748723320837601123029911367938627089438799362016295154133714248928307220126901475466847653576164773794675200490757155527819653621323926406160136358155907422020203187277605277219005561484255518792530343513984425322341576233610642506390497500865627109535919465897514131034822769306247435363256916078154781811528436679570611086153315044521274739245449454236828860613408414863776700961207151249140430272538607648236341433462351897576645216413767969031495019108575984423919862916421939949072362346468441173940326591840443780513338945257423995082965912285085558215725031071257012668302402929525220118726767562204154205161841634847565169998116141010029960783869092916030288400269104140792886215078424516709087000699282120660418371806535567252532567532861291042487761825829765157959847035622262934860034158722980534989650226291748788202734209222245339856264766914905562842503912757710284027998066365825488926488025456610172967026640765590429099456815065265305371829412703369313785178609040708667114965583434347693385781711386455873678123014587687126603489139095620099393610310291616152881384379099042317473363948045759314931405297634757481193567091101377517210080315590248530906692037671922033229094334676851422144773793937517034436619910403375111735471918550464490263655128162288244625759163330391072253837421821408835086573917715096828874782656995995744906617583441375223970968340800535598491754173818839994469748676265516582765848358845314277568790029095170283529716344562129640435231176006651012412006597558512761785838292041974844236080071930457618932349229279650198751872127267507981255470958904556357921221033346697499235630254947802490114195212382815309114079073860251522742995818072471625916685451333123948049470791191532673430282441860414263639548000448002670496248201792896476697583183271314251702969234889627668440323260927524960357996469256504936818360900323809293459588970695365349406034021665443755890045632882250545255640564482465151875471196218443965825337543885690941130315095261793780029741207665147939425902989695946995565761218656196733786236256125216320862869222103274889218654364802296780705765615144632046927906821207388377814233562823608963208068222468012248261177185896381409183903673672220888321513755600372798394004152970028783076670944474560134556417254370906979396122571429894671543578468788614445812314593571984922528471605049221242470141214780573455105008019086996033027634787081081754501193071412233908663938339529425786905076431006383519834389341596131854347546495569781038293097164651438407007073604112373599843452251610507027056235266012764848308407611830130527932054274628654036036745328651057065874882256981579367897669742205750596834408697350201410206723585020072452256326513410559240190274216248439140359989535394590944070469120914093870012645600162374288021092764579310657922955249887275846101264836999892256959688159205600101655256375678566722796619885782794848855834397518744545512965634434803966420557982936804352202770984294232533022576341807039476994159791594530069752148293366555661567873640053666564165473217043903521329543529169414599041608753201868379370234888689479151071637852902345292440773659495630510074210871426134974595615138498713757047101787957310422969066670214498637464595280824369445789772330048764765241339075920434019634039114732023380715095222010682563427471646024335440051521266932493419673977041595683753555166730273900749729736354964533288869844061196496162773449518273695588220757355176651589855190986665393549481068873206859907540792342402300925900701731960362254756478940647548346647760411463233905651343306844953979070903023460461470961696886885014083470405460742958699138296682468185710318879065287036650832431974404771855678934823089431068287027228097362480939962706074726455399253994428081137369433887294063079261595995462624629707062594845569034711972996409089418059534393251236235508134949004364278527138315912568989295196427287573946914272534366941532361004537304881985517065941217352462589548730167600298865925786628561249665523533829428785425340483083307016537228563559152534784459818313411290019992059813522051173365856407826484942764411376393866924803118364453698589175442647399882284621844900877769776312795722672655562596282542765318300134070922334365779160128093179401718598599933849235495640057099558561134980252499066984233017350358044081168552653117099570899427328709258487894436460050410892266917835258707859512983441729535195378855345737426085902908176515578039059464087350612322611200937310804854852635722825768203416050484662775045003126200800799804925485346941469775164932709504934639382432227188515974054702148289711177792376122578873477188196825462981268685817050740272550263329044976277894423621674119186269439650671515779586756482399391760426017633870454990176143641204692182370764887834196896861181558158736062938603810171215855272668300823834046564758804051380801633638874216371406435495561868964112282140753302655100424104896783528588290243670904887118190909494533144218287661810310073547705498159680772009474696134360928614849417850171807793068108546900094458995279424398139213505586422196483491512639012803832001097738680662877923971801461343244572640097374257007359210031541508936793008169980536520276007277496745840028362405346037263416554259027601834840306811381855105979705664007509426087885735796037324514146786703688098806097164258497595138069309449401515422221943291302173912538355915031003330325111749156969174502714943315155885403922164097229101129035521815762823283182342548326111912800928252561902052630163911477247331485739107775874425387611746578671169414776421441111263583553))));
        yaw = mc.player.rotationYaw + GCDCalcHelper.getFixedRotation(MathHelper.wrapDegrees(yaw - mc.player.rotationYaw));
        pitch = mc.player.rotationPitch + GCDCalcHelper.getFixedRotation(MathHelper.wrapDegrees(pitch - mc.player.rotationPitch));
        final float minValue = -90.0f;
        final float maxValue = 90.0f;
        pitch = MathHelper.clamp(pitch, minValue, maxValue);
        return new float[]{yaw, pitch};
         */
    	
    	Point q1 = new Point(entityIn.posX, entityIn.posY + 1, entityIn.posZ);
    	Point q0 = new Point(entityIn.posX, entityIn.posY, entityIn.posZ);
    	Point q2 = new Point(entityIn.posX, entityIn.posY - 1, entityIn.posZ);
    	
    	Point q3 = new Point(entityIn.posX - 0.2, entityIn.posY - 1, entityIn.posZ - 0.2);
    	Point q4 = new Point(entityIn.posX - 0.2, entityIn.posY - 1, entityIn.posZ + 0.2);
    	Point q5 = new Point(entityIn.posX + 0.2, entityIn.posY - 1, entityIn.posZ - 0.2);
    	Point q6 = new Point(entityIn.posX + 0.2, entityIn.posY - 1, entityIn.posZ + 0.2);
    	
    	Point q7 = new Point(entityIn.posX - 0.2, entityIn.posY + 1, entityIn.posZ - 0.2);
    	Point q8 = new Point(entityIn.posX - 0.2, entityIn.posY + 1, entityIn.posZ + 0.2);
    	Point q9 = new Point(entityIn.posX + 0.2, entityIn.posY + 1, entityIn.posZ - 0.2);
    	Point q10 = new Point(entityIn.posX + 0.2, entityIn.posY + 1, entityIn.posZ + 0.2);
    	
    	Point q11 = new Point(entityIn.posX - 0.2, entityIn.posY, entityIn.posZ - 0.2);
    	Point q12 = new Point(entityIn.posX - 0.2, entityIn.posY, entityIn.posZ + 0.2);
    	Point q13 = new Point(entityIn.posX + 0.2, entityIn.posY, entityIn.posZ - 0.2);
    	Point q14 = new Point(entityIn.posX + 0.2, entityIn.posY, entityIn.posZ + 0.2);
    	
    	
    	
    	final List<Point> p = new ArrayList<Point>();
    	
    	p.add(q1);
    	p.add(q2);
    	p.add(q0);
    	
    	p.add(q3);
    	p.add(q4);
    	p.add(q5);
    	p.add(q6);
    	
    	p.add(q7);
    	p.add(q8);
    	p.add(q9);
    	p.add(q10);
    	
    	p.add(q11);
    	p.add(q12);
    	p.add(q13);
    	p.add(q14);
    	
    	
    	p.sort(Comparator.comparingDouble(mc.player::getDistanceToPoint));
    	
    	
        Vec3d eyesPos = new Vec3d(mc.player.posX + MathematicHelper.randomizeFloat(-1, 2) / 15, mc.player.posY + (double) mc.player.getEyeHeight() - 0.6, mc.player.posZ + MathematicHelper.randomizeFloat(-1, 2) / 15);
        double diffY = /*entityIn.getPositionVector().yCoord - eyesPos.yCoord*/ p.get(0).getY() - eyesPos.yCoord;
        double diffX = p.get(0).getX() + ((p.get(0).getX() - entityIn.prevPosX)) * (predict.getBoolValue() ? mc.player.connection.getPlayerInfo(mc.player.getUniqueID()).getResponseTime() / 2 : 0)  - mc.player.posX - mc.player.motionX * (predict.getBoolValue() ? mc.player.connection.getPlayerInfo(mc.player.getUniqueID()).getResponseTime() / 2 : 0);
        double diffZ = p.get(0).getZ() + ((p.get(0).getZ() - entityIn.prevPosZ))  * (predict.getBoolValue() ? mc.player.connection.getPlayerInfo(mc.player.getUniqueID()).getResponseTime() / 2 : 0) - mc.player.posZ - mc.player.motionZ * (predict.getBoolValue() ? mc.player.connection.getPlayerInfo(mc.player.getUniqueID()).getResponseTime() / 2 : 0);
        double diffXZ = Math.sqrt(diffX * diffX + diffZ * diffZ);
        float yaw = MathHelper.wrapDegrees((float) Math.toDegrees(Math.atan2(diffZ, diffX)) - 90.0f);
        float pitch = MathHelper.wrapDegrees((float) (-Math.toDegrees(Math.atan2(diffY, diffXZ))) - 10.0f);
        float f = mc.gameSettings.mouseSensitivity * 0.6f + 0.2f ;
        float gcd = f * f * f * 1.2f;
        yaw -= yaw % gcd;
        pitch -= pitch % gcd;
        return new float[]{yaw, pitch};
    }
    
    @EventTarget
    public void onAttackSilent(EventAttackSilent eventAttackSilent) {
    	if (hitCounter <= 1 && smartFix.getBoolValue()) {
  		  return;
  	  }
  	  if (mc.player.isBlocking() && mc.player.getHeldItemOffhand().getItem() instanceof ItemShield) {
        	mc.player.connection.sendPacket(new CPacketPlayerDigging(CPacketPlayerDigging.Action.RELEASE_USE_ITEM, new BlockPos(-0.8, -0.8, -0.8), EnumFacing.DOWN));
            mc.playerController.processRightClick(mc.player, mc.world, EnumHand.OFF_HAND);
            timerHelper.reset();
        }
    }
    
    @EventTarget
    public void onUpdate(EventUpdate event) {
    	/*
    	if (target != null) {
    		if (target.getHeldItemMainhand().getItem() instanceof ItemAxe) {
                if (mc.gameSettings.keyBindUseItem.isKeyDown()) {
                    mc.gameSettings.keyBindUseItem.pressed = false;
                }
            } else {
                mc.gameSettings.keyBindUseItem.pressed = Mouse.isButtonDown(1);
            }
    	}*/
    }
    
    public void breakShield(EntityLivingBase tg) {
        if (InventoryHelper.doesHotbarHaveAxe()) {
            int item = InventoryHelper.getAxe();
            if (InventoryHelper.getAxe() >= 0 && tg instanceof EntityPlayer && tg.isHandActive() && tg.getActiveItemStack().getItem() instanceof ItemShield) {
                mc.player.connection.sendPacket(new CPacketHeldItemChange(item));
                mc.playerController.attackEntity(mc.player, EntityHelper.rayCast(target, calculateRange()));
                mc.player.swingArm(EnumHand.MAIN_HAND);
                mc.player.connection.sendPacket(new CPacketHeldItemChange(mc.player.inventory.currentItem));
            }
        }
    }
    
    @EventTarget
    public void onSendPacket(final EventPacket event) {
    	if (event.getPacket() instanceof SPacketPlayerPosLook) {
            final SPacketPlayerPosLook packet1 = (SPacketPlayerPosLook)event.getPacket();
            mc.player.rotationYaw = packet1.getYaw();
            mc.player.rotationPitch = packet1.getPitch();
        }
    }
    
    @EventTarget
    public void onRotations(EventPreMotionUpdate event) {
        if (isToggled()) {
            if (target != null) {
                if (target.getHealth() > 0.0f) {
                	 final float[] matrix = rotations(target);
                	 
                     event.setYaw(matrix[0]);
                     event.setPitch(matrix[1]);
                     KillAura.yaw = matrix[0];
                     KillAura.mc.player.renderYawOffset = matrix[0];
                     KillAura.mc.player.rotationYawHead = matrix[0];
                     KillAura.mc.player.rotationPitchHead = matrix[1];
                }
            }    
        }

    }

    @EventTarget
    public void onRender2D(EventRender2D e) {
    	if (this.progress2 < 1.0f) {
     		 this.progress2 = (System.currentTimeMillis() - this.lastMS) / 250.0f;
	} else {
		this.progress2 = 1.0f;
	}
	
	if (progress2 >= 0.7f) {
		if (this.progress < 1.0f) {
    		 this.progress = (System.currentTimeMillis() - this.lastMS) / 550.0f;
		} else {
			this.progress = 1.0f;
		}
	}
	boolean a = progress2 >= 1.0f;
	
            if (target instanceof EntityPlayer) {
            	final float x = TargetHudComponent.x;
                final float y = TargetHudComponent.y;
                int color = 15;
                double hpWidth = (target.getHealth() / target.getMaxHealth() * 78);
                this.healthBarWidth = AnimationHelper.animate(hpWidth, this.healthBarWidth, 3 * Feature.deltaTime());
                RoundedUtil.drawGradientHorizontal(x + 182 - 60 * progress2, y - 13.5f * progress2, (mc.mntsb_20.getStringWidth(target.getName()) > 60 ? mc.mntsb_20.getStringWidth(target.getName()) + 60 : 60 + 70) * progress2, 9.5f + 30 * progress2, 7, ClientHelper.getClientColor().darker(), ClientHelper.getClientColor());
                
                GlStateManager.pushMatrix();
                GlStateManager.enable(GL11.GL_SCISSOR_TEST);
                RenderUtils.scissorRect(x + 182 - 60, y - 13.5f, x + (mc.mntsb_20.getStringWidth(target.getName()) > 60 ? mc.mntsb_20.getStringWidth(target.getName()) + 115 : 115 + 70) - 60 + 128, y - 13.5f + 9.5f + 30);
                if (!target.getName().isEmpty()) {
                	Util.drawHead2(Objects.requireNonNull(mc.getConnection()).getPlayerInfo(target.getUniqueID()).getLocationSkin(), (int) ((int) x + 216 + (mc.mntsb_20.getStringWidth(target.getName()) > 60 ? mc.mntsb_20.getStringWidth(target.getName()) + 30 : 30 + 70) - 100 * progress), (int) (y - 9f));
                }
                mc.mntsb_13.drawStringWithShadow("Distance: " + String.format("%.1f", Float.valueOf(mc.player.getDistanceToEntity(target))), x + 101.0f - 70 + 105.0f * progress - mc.neverlose500_16.getStringWidth(String.valueOf((int) target.getHealth() / 2.0f)) / 2.0f, y + 5.5f, -1);
                mc.mntsb_20.drawStringWithShadow(target.getName(), x + 128 - 105 + 105 * progress, y - 7.0f, -1);
                mc.getRenderItem().renderItemOverlays(mc.neverlose500_18, target.getHeldItem(EnumHand.OFF_HAND), (int) x + 228, (int) y - 35);
                mc.getRenderItem().renderItemIntoGUI(target.getHeldItem(EnumHand.OFF_HAND), (int)  x + 222, (int) y - 35);
                
                //DrawHelper.drawGradientRect1(x - 1 + 160 - 32 - 105 + 105 * progress, y + 13.0f - 1, x + 1 - 105 + 105 * progress + 160.0f + (78 - 32), y + 1 + 20.0f, ClientHelper.getClientColor().darker().getRGB(), ClientHelper.getClientColor().darker().getRGB());
                
                if (target.hurtTime > 0) {
                DrawHelper.drawTriangle((float) (x - 105 + 105 * progress + 160.0f + (healthBarWidth - 32)) - 4.5f, y + 8, 4.0F, 4.0F, new Color(50, 50, 50, 255 * target.hurtTime / 10).getRGB(), new Color(50, 50, 50, 255 * target.hurtTime / 10).getRGB());
                RenderUtils.drawFilledCircle((float) (x - 105 + 105 * progress + 160 + (healthBarWidth - 32.5f)), (int) (y + 6), 4, new Color(50, 50, 50, 255 * target.hurtTime / 10));
                DrawHelper.drawGradientRect1(x, y, x, y, ClientHelper.getClientColor().getRGB(), ClientHelper.getClientColor().brighter().getRGB());
                mc.mntsb_10.drawCenteredString("" + (int) target.getHealth(), (float) (x - 105 + 105 * progress + 160 + (healthBarWidth - 32.5f)), (int) (y + 6), -1);
                }
                
                DrawHelper.drawGradientRect1(x + 160 - 32 - 105 + 105 * progress, y + 13.0f, x - 105 + 105 * progress + 160.0f + (healthBarWidth - 32), y + 20.0f, ClientHelper.getClientColor().getRGB(), ClientHelper.getClientColor().brighter().getRGB());
                
                GlStateManager.disable(GL11.GL_SCISSOR_TEST);
                GlStateManager.popMatrix();
                
            } else {
            	 ScaledResolution sr = new ScaledResolution(mc);
            	 GlStateManager.pushMatrix();
                 GlStateManager.enable(GL11.GL_SCISSOR_TEST);
                 RenderUtils.scissorRect(0, 0,  sr.getScaledWidth(), sr.getScaledHeight());
                 
            	GlStateManager.disable(GL11.GL_SCISSOR_TEST);
                GlStateManager.popMatrix();
                this.healthBarWidth = 92.0;
                target = null;
            }
    }
    
    private void attackEntitySuccess(EntityLivingBase target) {
        if (target.getHealth() > 0) {
            if ((mc.player.getCooledAttackStrength(0.5f) >= (0.95f) || (target.getHealth() <= 1 && mc.player.ticksExisted % 5 == 0))  && mc.player.getDistanceToEntity(target) <= (Jesus.inWater ? calculateRange() : calculateRange() - 1)) {
            	if (snap.getBoolValue()) {
            		float[] rotVisual = RotationHelper.getMatrixRotations(target, false, 2, 2);
    				mc.player.rotationYaw = rotVisual[0];
                    mc.player.rotationYaw = rotVisual[0];
                    mc.player.rotationPitch = rotVisual[1];
                    mc.player.rotationPitch = rotVisual[1];
            	}
                mc.player.connection.sendPacket(new CPacketEntityAction(mc.player, CPacketEntityAction.Action.STOP_SPRINTING));
                mc.playerController.attackEntity(mc.player, EntityHelper.rayCast(target, calculateRange()));
                mc.player.swingArm(EnumHand.MAIN_HAND);
                if (hitCounter > 1) {
                	breakShield(target);
                }
            	mc.player.connection.sendPacket(new CPacketEntityAction(mc.player, CPacketEntityAction.Action.START_SPRINTING));
                hitCounter++;
        	}
        }
    }
    
    @EventTarget
    public void onEventPreMotion(EventPreMotionUpdate mamanooma) {
        if (isToggled()) {
            if (Minecraft.getMinecraft().player.isEntityAlive()) {
            	boolean a = false;
                if (!AutoTotem.checkCrystal.getBoolValue()) {
                    a = false;
                }
                for (final Entity entity : mc.world.loadedEntityList) {
                    if (entity instanceof EntityEnderCrystal && mc.player.getDistanceToEntity(entity) <= 8) {
                    		a = true;
                    }
                }
                
                if (a) {
                	if (crysSafe.getBoolValue())
                	mc.player.motionY -= 1000;
                }
                target = getSortEntities();
                if (target == null) {
                    return;
                }
                if (target.getHealth() > 0.0f) {
                	BlockPos blockPos = new BlockPos(mc.player.posX, mc.player.posY - 0.1, mc.player.posZ);
                    Block block = mc.world.getBlockState(blockPos).getBlock();
                	if (!Jesus.inWater) {
                		if (!(mc.player.onGround && mc.player.fallDistance == 0 && !mc.gameSettings.keyBindJump.isKeyDown()) && target.getHealth() > 2) {
                			if (!MovementHelper.isBlockAboveHead()) {
                  		      if (!(mc.player.fallDistance >= 0.08f || block instanceof BlockLiquid || mc.player.isRiding() || mc.player.isOnLadder() || mc.player.isInLiquid() || mc.player.isInWeb)) {
                                    mc.player.connection.sendPacket(new CPacketEntityAction(mc.player, CPacketEntityAction.Action.STOP_SPRINTING));
                                    return;
                                }
                            } else if (!(!(mc.player.fallDistance > 0.0f) || mc.player.onGround || mc.player.isRiding() || mc.player.isOnLadder() || mc.player.isInLiquid() || mc.player.isInWeb)) {
                                mc.player.connection.sendPacket(new CPacketEntityAction(mc.player, CPacketEntityAction.Action.STOP_SPRINTING));
                                return;
                            }
                		}
                	}
                	
                    attackEntitySuccess(target);
                }
            }
        }
    }
    
    public EntityLivingBase getSortEntities() {
        final List<EntityLivingBase> e2 = new ArrayList<EntityLivingBase>();
        for (final Entity e3 : KillAuraHelper.mc.world.loadedEntityList) {
            if (e3 instanceof EntityLivingBase) {
                final EntityLivingBase player = (EntityLivingBase)e3;
                if (mc.player.getDistanceToEntity(player) >= calculateRange() + (snap.getBoolValue() ? 0 : 1) || !canAttack(player)) {
                    continue;
                }
                e2.add(player);
            }
        }

            e2.sort(Comparator.comparingDouble(mc.player::getDistanceToEntity));

        if (e2.isEmpty())
            return null;

        return e2.get(0);
    }
}
